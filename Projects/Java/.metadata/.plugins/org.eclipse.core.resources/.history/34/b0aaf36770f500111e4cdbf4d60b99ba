package org.tju.utils;

import java.io.InputStream;

import org.apache.commons.httpclient.DefaultHttpMethodRetryHandler;
import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.HttpStatus;
import org.apache.commons.httpclient.methods.GetMethod;
import org.apache.commons.httpclient.params.HttpMethodParams;
import org.cyberneko.html.parsers.DOMParser;
import org.dom4j.io.DOMReader;
import org.xml.sax.InputSource;

public class WebUtil {

	private String IP_URL="http://www.webxml.com.cn/WebServices/" +
			"IpAddressSearchWebService.asmx/getCountryCityByIp?theIpAddress=";
	
	public Document getCityByIP(String ip) throws Exception {
		HttpClient client = new HttpClient();
		GetMethod method = new GetMethod(this.IP_URL+ip);
		method.getParams().setParameter(HttpMethodParams.RETRY_HANDLER,
				new DefaultHttpMethodRetryHandler());
		int status = client.executeMethod(method);
		if (status != HttpStatus.SC_OK) {
			System.err.println("ddd");
		}
		InputStream stream = method.getResponseBodyAsStream();
		DOMParser parser = new DOMParser();
		parser.parse(new InputSource(stream));
		
		return parse(parser.getDocument());
	}
	
	 public org.dom4j.Document parse(Document document) throws Exception {    
	       if (document == null	) return null;
	       DOMReader reader = new DOMReader();
	       return reader.read(document);
	   }
}
