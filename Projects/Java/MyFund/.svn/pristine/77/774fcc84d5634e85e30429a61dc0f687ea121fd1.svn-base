package com.zj198.action.news;

import java.util.Calendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.zj198.action.BaseAction;
import com.zj198.model.KnwTitle;
import com.zj198.model.KnwType;
import com.zj198.model.PrdFinance;
import com.zj198.model.PrdRecommendation;
import com.zj198.service.finservice.FinanceProdService;
import com.zj198.service.loan.FinanceProductService;
import com.zj198.service.news.NewsService;
import com.zj198.util.Constants;
import com.zj198.util.Pager;

public class KnwTitleAction extends BaseAction {

	//新闻主页面，每页２０条
	private static final Integer pageSize = 20;
//	//在其他页面嵌入的新闻,每页面５条
//	private static final Integer PAGE_SIZE=5;
	
	private boolean continueToAdd = false;
	private Integer id;
	private Integer typeId = 0;

	private Integer pageNo = 1;
	private KnwTitle knwTitle;
	private Pager pager;
	private List<KnwType> knwTypeList;
	
	
	private NewsService newsService;
	private FinanceProductService financeProductService;
	private FinanceProdService financeProdService;
	private KnwType knwType;
	
	private List<KnwTitle> siteNews;
	private List<KnwTitle> financingNews;
	private List<KnwTitle> finacialNews;
	
	private List<PrdRecommendation> bankFinanceRecommendationList;
	
	/**热门融资产品*/
	private List<PrdFinance> prdFinanceList;
	
	private Integer titleId;
	
	/**
	 * 常见问题
	 * 注册与登陆
	 * 融资与服务
	 * 服务协议与规则
	 */
	private Map<String,List<KnwTitle>> knwTitleMap;
	
	@Override
	public String execute() throws Exception {
		return null;
	}
	public String showDetail(){
		this.knwTitle = newsService.getKnwTitleById(titleId);
		if(knwTitle.getTypeId() == Constants.NEWS_COMMON_ISSUES || 
				knwTitle.getTypeId() == Constants.NEWS_REGISTER_LOGIN || 
				knwTitle.getTypeId() == Constants.NEWS_FINANCING_SERVICE || 
				knwTitle.getTypeId() == Constants.NEWS_SERVICE_AGREEMENT){
			knwTitleMap = new HashMap<String, List<KnwTitle>>();
			knwTitleMap.put("NEWS_COMMON_ISSUES", newsService.findKnwTitleByType(Constants.NEWS_COMMON_ISSUES));
			knwTitleMap.put("NEWS_REGISTER_LOGIN", newsService.findKnwTitleByType(Constants.NEWS_REGISTER_LOGIN));
			knwTitleMap.put("NEWS_FINANCING_SERVICE", newsService.findKnwTitleByType(Constants.NEWS_FINANCING_SERVICE));
			knwTitleMap.put("NEWS_SERVICE_AGREEMENT", newsService.findKnwTitleByType(Constants.NEWS_SERVICE_AGREEMENT));
			return "common";
		}else if(knwTitle.getTypeId() == Constants.NEWS_FINANCING_DICTIONARY){
			siteNews = newsService.findKnwTitleByType(Constants.NEWS_FINANCING_DICTIONARY);
			return "knowledge";
		}else if(knwTitle.getTypeId() == Constants.NEWS_FINACING_ENCYCLOPEDIA){
			siteNews = newsService.findKnwTitleByType(Constants.NEWS_FINACING_ENCYCLOPEDIA);	
			return "knowledge";
		}else{
			bankFinanceRecommendationList = this.financeProdService.findRecommendationByTopNumber(1, 5);
			prdFinanceList = financeProductService.findFinanceImportent(5);
			return "detail";
		}
	}
	public String infoCenter(){
		siteNews = newsService.findLastestByType(Constants.SITE_NEWS, 5);
		financingNews = newsService.findLastestByType(Constants.FINANCING_NEWS, 5);
		finacialNews = newsService.findLastestByType(Constants.FINANCIAL_NEWS, 5);
		return "center";
	}
	
	public String showHome() {
		this.bankFinanceRecommendationList = this.financeProdService.findRecommendationByTopNumber(1, 5);
		knwTypeList = newsService.findAllKnwType();
		knwType = newsService.getKnwTypeById(typeId);
		pager = newsService.findKnwTitleByType(typeId, pageSize, pageNo, Short.valueOf("1"), 1);
		return SUCCESS;
	}
	
	public String edit() {
		this.knwTypeList = newsService.findAllKnwType();
		this.getKnwTitleById(id);
		if (knwTitle.getTypeId() == null || knwTitle.getTypeId().intValue()<1) {
			KnwType type = newsService.getKnwTypeById(Integer.valueOf(this.typeId));
			this.knwTitle.setTypeId(type.getId());
			this.knwTitle.setTypeName(type.getName());
		}
		return "edit";
	}
	
	public String save() {
		String redirect;
		knwTitle.setIssuedDate(Calendar.getInstance().getTime());
		this.newsService.saveKnwTitle(knwTitle);
		this.typeId = knwTitle.getTypeId();
		if (continueToAdd) {
			id = 0;
			redirect = this.showHome();
		} else {
			redirect = this.edit();
		}
		return redirect;
	}
	
	public String delete() {
		this.getKnwTitleById(id);
		this.newsService.deleteKnwTitle(knwTitle);
		return this.showHome();
	}
	
	public String findUnAuthenticatedTitles() {
		pager = this.newsService.findUnAuthenticatedTitleList(pageSize, pageNo);
		return SUCCESS;
	}
	
	private void getKnwTitleById(Integer id) {
		if (id == null) {
			knwTitle = new KnwTitle();
		} else {
			knwTitle = newsService.getKnwTitleById(id);
		}
	}
	

	public Integer getKnwTypeId() {
		return typeId;
	}

	public void setKnwTypeId(Integer knwTypeId) {
		this.typeId = knwTypeId;
	}

	public NewsService getNewsService() {
		return newsService;
	}

	public void setNewsService(NewsService newsService) {
		this.newsService = newsService;
	}

	public KnwTitle getKnwTitle() {
		return knwTitle;
	}

	public void setKnwTitle(KnwTitle knwTitle) {
		this.knwTitle = knwTitle;
	}


	public Pager getPager() {
		return pager;
	}

	public Integer getPageNo() {
		return pageNo;
	}

	public void setPageNo(Integer pageNo) {
		this.pageNo = pageNo;
	}

	public Integer getId() {
		return id;
	}

	public void setId(Integer id) {
		this.id = id;
	}

	public Integer getTypeId() {
		return typeId;
	}

	public void setTypeId(Integer typeId) {
		this.typeId = typeId;
	}

	public boolean isContinueToAdd() {
		return continueToAdd;
	}

	public void setContinueToAdd(boolean continueToAdd) {
		this.continueToAdd = continueToAdd;
	}

	public List<KnwType> getKnwTypeList() {
		return knwTypeList;
	}

	public void setKnwTypeList(List<KnwType> knwTypeList) {
		this.knwTypeList = knwTypeList;
	}

	public List<KnwTitle> getSiteNews() {
		return siteNews;
	}

	public void setSiteNews(List<KnwTitle> siteNews) {
		this.siteNews = siteNews;
	}

	public List<KnwTitle> getFinancingNews() {
		return financingNews;
	}

	public void setFinancingNews(List<KnwTitle> financingNews) {
		this.financingNews = financingNews;
	}

	public List<KnwTitle> getFinacialNews() {
		return finacialNews;
	}

	public void setFinacialNews(List<KnwTitle> finacialNews) {
		this.finacialNews = finacialNews;
	}

	public KnwType getKnwType() {
		return knwType;
	}
	public Integer getTitleId() {
		return titleId;
	}
	public void setTitleId(Integer titleId) {
		this.titleId = titleId;
	}
	public void setFinanceProductService(FinanceProductService financeProductService) {
		this.financeProductService = financeProductService;
	}
	public List<PrdFinance> getPrdFinanceList() {
		return prdFinanceList;
	}
	public Map<String, List<KnwTitle>> getKnwTitleMap() {
		return knwTitleMap;
	}
	public void setKnwTitleMap(Map<String, List<KnwTitle>> knwTitleMap) {
		this.knwTitleMap = knwTitleMap;
	}

	public List<PrdRecommendation> getBankFinanceRecommendationList() {
		return bankFinanceRecommendationList;
	}
	public void setFinanceProdService(FinanceProdService financeProdService) {
		this.financeProdService = financeProdService;
	}
	

}
